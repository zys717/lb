{
  "scenario": "S030",
  "summary": {
    "total_test_cases": 8,
    "llm_calls": 8,
    "llm_accuracy": "6/8",
    "llm_accuracy_percent": "75.0%"
  },
  "results": [
    {
      "test_case_id": "TC1_BaselineScheduling",
      "description": "Simple prioritization with no dynamic changes.",
      "expected_decision": "CONDITIONAL_APPROVE",
      "llm_decision": "CONDITIONAL_APPROVE",
      "prompt": "# UTM Dynamic Scheduling Decision\n\n## Scenario Info\n- Scenario ID: S030\n- Test Case: TC1_BaselineScheduling\n- Description: Simple prioritization with no dynamic changes.\n\n## Drone Profiles\n- Drone A: {'role': 'medical_emergency', 'distance_km': 5, 'deadline_min': 30}\n- Drone B: {'role': 'commercial_delivery', 'distance_km': 3, 'deadline_min': 45, 'wind_limit_ms': 12}\n- Drone C: {'role': 'infrastructure_inspection', 'distance_km': 2, 'deadline_min': None}\n\n## Global Rules\n- R1: medical > commercial > inspection\n- R2: single drone per corridor (500m spacing)\n- R3: B wind limit 12 m/s\n- R4: 15% battery reserve\n\n## Current Conditions\n- All drones have >60% battery\n- No weather issues\n- No temporary NFZ\n\n---\n\n## Output Requirements\n1. **Decision**: Provide a JSON object with per-drone allocations (e.g., immediate launch, delay X minutes, reroute, reject).\n2. **Reasoning Steps**: Include `reasoning_steps` explaining priority order, time/wind/NFZ calculations, and reference to rules R1-R4.\n3. **Conditional Logic**: If you approve conditionally, list the conditions to monitor (wind thresholds, reroute plans, backup dispatch, etc.).\n4. **Time/Battery Math**: Show calculations when rejecting (e.g., total minutes exceed deadline) or when windows are tight.\n5. **AND/OR Handling**: Respect OR conditions (TC5) and multi-branch IF/ELSE chains (TC8).\n6. **Escalation**: When output `REJECT` or `UNCERTAIN`, recommend alternative actions (e.g., dispatch backup UAV).\n\nReturn JSON such as:\n```json\n{\n  \"decision\": \"CONDITIONAL_APPROVE\",\n  \"allocations\": [\n    {\"drone\": \"A\", \"action\": \"launch_now\"},\n    {\"drone\": \"B\", \"action\": \"launch_after\", \"delay_min\": 5},\n    {\"drone\": \"C\", \"action\": \"delay\", \"delay_min\": 15}\n  ],\n  \"conditions\": [\n    \"Abort B if wind >= 14 m/s before completion\",\n    \"Monitor NFZ activation time\"\n  ],\n  \"reasoning_steps\": [\n    \"Step1...\",\n    \"Step2...\"\n  ]\n}\n```\n\n\n# Retrieved Evidence\n\n\n(no constraints found)\nDecision rule: Respect priority ordering and spacing; monitor wind/charging/NFZ dynamics. If wind/charging constraints risk reserve or delay, prefer CONDITIONAL_APPROVE with monitoring or REJECT if infeasible. Temporary NFZ requires reroute or waiver; without it, do not approve a plan that violates NFZ. If charging delay blocks schedule, REJECT unless a viable staggered plan is provided.\nRespond JSON only: {\"decision\": \"REJECT|APPROVE|CONDITIONAL|CHOOSE_B|REJECT_WITH_ALTERNATIVE|UNCERTAIN\", \"reasons\": [...], \"citations\": [...], \"evidence_used\": [...]}. Cite option/waiver/priority fields when relevant.",
      "llm_raw": "```json\n{\n  \"decision\": \"CONDITIONAL_APPROVE\",\n  \"allocations\": [\n    {\n      \"drone\": \"A\",\n      \"action\": \"launch_now\"\n    },\n    {\n      \"drone\": \"B\",\n      \"action\": \"launch_after\",\n      \"delay_min\": 5\n    },\n    {\n      \"drone\": \"C\",\n      \"action\": \"launch_after\",\n      \"delay_min\": 10\n    }\n  ],\n  \"conditions\": [\n    \"Monitor wind speed for Drone B. If wind exceeds 12 m/s before or during its flight, Drone B's mission must be aborted or re-evaluated.\",\n    \"No temporary NFZ activation.\"\n  ],\n  \"reasoning_steps\": [\n    \"1. **Establish Priority (R1):** Based on Global Rule R1 (medical > commercial > inspection), the drones are prioritized as follows: Drone A (medical_emergency) > Drone B (commercial_delivery) > Drone C (infrastructure_inspection).\",\n    \"2. **Calculate Estimated Flight Times:** Assuming an average drone speed of 0.6 km/min (10 m/s) for planning purposes:\",\n    \"   - Drone A (5km): 5 km / 0.6 km/min = ~8.33 minutes.\",\n    \"   - Drone B (3km): 3 km / 0.6 km/min = 5 minutes.\",\n    \"   - Drone C (2km): 2 km / 0.6 km/min = ~3.33 minutes.\",\n    \"3. **Process Drone A (Highest Priority):**\",\n    \"   - **Assessment:** Drone A has the highest priority ('medical_emergency'). Its deadline is 30 minutes, and its estimated flight time is ~8.33 minutes. Current battery is >60% (meeting R4: 15% reserve requirement) and there are no weather or NFZ issues.\",\n    \"   - **Decision:** Approve 'launch_now' (at T=0). This respects its priority and ample deadline.\",\n    \"4. **Apply Spacing Rule (R2) for Subsequent Drones:** Global Rule R2 specifies 'single drone per corridor (500m spacing)'. To ensure this and provide a safe operational buffer, a 5-minute interval between subsequent launches will be applied. This buffer allows for sufficient spatial separation (e.g., at 0.6 km/min, a 5-minute gap means 3 km separation).\",\n    \"5. **Process Drone B (Medium Priority):**\",\n    \"   - **Launch Slot:** Due to R2 and Drone A's immediate launch, Drone B can launch no earlier than T=0 + 5 minutes = T=5 minutes.\",\n    \"   - **Assessment:** Drone B has a medium priority ('commercial_delivery'). Its deadline is 45 minutes. If launched at T=5, its arrival time would be T=5 (launch) + 5 (flight) = T=10 minutes, which is well within the 45-minute deadline. Battery is >60% (meeting R4).\",\n    \"   - **Wind Limit (R3):** Drone B has a wind limit of 12 m/s. Current conditions state 'No weather issues', but this is a critical condition to monitor for a commercial drone. Hence, a conditional approval.\",\n    \"   - **Decision:** Approve 'launch_after' with a delay of 5 minutes (from T=0). This launch at T=5 is conditional on maintaining wind within limits.\",\n    \"6. **Apply Spacing Rule (R2) for Subsequent Drones:** Due to R2 and Drone B's planned launch at T=5, Drone C can launch no earlier than T=5 + 5 minutes = T=10 minutes.\",\n    \"7. **Process Drone C (Lowest Priority):**\",\n    \"   - **Launch Slot:** Due to R2 and Drone B's launch, Drone C can launch no earlier than T=10 minutes.\",\n    \"   - **Assessment:** Drone C has the lowest priority ('infrastructure_inspection') and no specified deadline. Its estimated flight time is ~3.33 minutes. If launched at T=10, its arrival would be T=10 (launch) + 3.33 (flight) = T=13.33 minutes, which is acceptable given no deadline. Battery is >60% (meeting R4).\",\n    \"   - **Decision:** Approve 'launch_after' with a delay of 10 minutes (from T=0).\",\n    \"8. **Final Review:** All drones are scheduled respecting their priorities (R1) and the corridor spacing rule (R2). All deadlines are met, battery reserve (R4) is sufficient, and current weather/NFZ conditions are favorable. Drone B's wind limit (R3) requires ongoing monitoring, leading to a 'CONDITIONAL_APPROVE' decision.\"\n  ]\n}\n```",
      "llm_parsed": {
        "decision": "CONDITIONAL_APPROVE",
        "allocations": [
          {
            "drone": "A",
            "action": "launch_now"
          },
          {
            "drone": "B",
            "action": "launch_after",
            "delay_min": 5
          },
          {
            "drone": "C",
            "action": "launch_after",
            "delay_min": 10
          }
        ],
        "conditions": [
          "Monitor wind speed for Drone B. If wind exceeds 12 m/s before or during its flight, Drone B's mission must be aborted or re-evaluated.",
          "No temporary NFZ activation."
        ],
        "reasoning_steps": [
          "1. **Establish Priority (R1):** Based on Global Rule R1 (medical > commercial > inspection), the drones are prioritized as follows: Drone A (medical_emergency) > Drone B (commercial_delivery) > Drone C (infrastructure_inspection).",
          "2. **Calculate Estimated Flight Times:** Assuming an average drone speed of 0.6 km/min (10 m/s) for planning purposes:",
          "   - Drone A (5km): 5 km / 0.6 km/min = ~8.33 minutes.",
          "   - Drone B (3km): 3 km / 0.6 km/min = 5 minutes.",
          "   - Drone C (2km): 2 km / 0.6 km/min = ~3.33 minutes.",
          "3. **Process Drone A (Highest Priority):**",
          "   - **Assessment:** Drone A has the highest priority ('medical_emergency'). Its deadline is 30 minutes, and its estimated flight time is ~8.33 minutes. Current battery is >60% (meeting R4: 15% reserve requirement) and there are no weather or NFZ issues.",
          "   - **Decision:** Approve 'launch_now' (at T=0). This respects its priority and ample deadline.",
          "4. **Apply Spacing Rule (R2) for Subsequent Drones:** Global Rule R2 specifies 'single drone per corridor (500m spacing)'. To ensure this and provide a safe operational buffer, a 5-minute interval between subsequent launches will be applied. This buffer allows for sufficient spatial separation (e.g., at 0.6 km/min, a 5-minute gap means 3 km separation).",
          "5. **Process Drone B (Medium Priority):**",
          "   - **Launch Slot:** Due to R2 and Drone A's immediate launch, Drone B can launch no earlier than T=0 + 5 minutes = T=5 minutes.",
          "   - **Assessment:** Drone B has a medium priority ('commercial_delivery'). Its deadline is 45 minutes. If launched at T=5, its arrival time would be T=5 (launch) + 5 (flight) = T=10 minutes, which is well within the 45-minute deadline. Battery is >60% (meeting R4).",
          "   - **Wind Limit (R3):** Drone B has a wind limit of 12 m/s. Current conditions state 'No weather issues', but this is a critical condition to monitor for a commercial drone. Hence, a conditional approval.",
          "   - **Decision:** Approve 'launch_after' with a delay of 5 minutes (from T=0). This launch at T=5 is conditional on maintaining wind within limits.",
          "6. **Apply Spacing Rule (R2) for Subsequent Drones:** Due to R2 and Drone B's planned launch at T=5, Drone C can launch no earlier than T=5 + 5 minutes = T=10 minutes.",
          "7. **Process Drone C (Lowest Priority):**",
          "   - **Launch Slot:** Due to R2 and Drone B's launch, Drone C can launch no earlier than T=10 minutes.",
          "   - **Assessment:** Drone C has the lowest priority ('infrastructure_inspection') and no specified deadline. Its estimated flight time is ~3.33 minutes. If launched at T=10, its arrival would be T=10 (launch) + 3.33 (flight) = T=13.33 minutes, which is acceptable given no deadline. Battery is >60% (meeting R4).",
          "   - **Decision:** Approve 'launch_after' with a delay of 10 minutes (from T=0).",
          "8. **Final Review:** All drones are scheduled respecting their priorities (R1) and the corridor spacing rule (R2). All deadlines are met, battery reserve (R4) is sufficient, and current weather/NFZ conditions are favorable. Drone B's wind limit (R3) requires ongoing monitoring, leading to a 'CONDITIONAL_APPROVE' decision."
        ]
      },
      "mission": {},
      "retrieved_constraints": []
    },
    {
      "test_case_id": "TC2_WindForecast",
      "description": "Wind rises to 14 m/s in 15 minutes; B limit is 12 m/s.",
      "expected_decision": "CONDITIONAL_APPROVE",
      "llm_decision": "CONDITIONAL_APPROVE",
      "prompt": "# UTM Dynamic Scheduling Decision\n\n## Scenario Info\n- Scenario ID: S030\n- Test Case: TC2_WindForecast\n- Description: Wind rises to 14 m/s in 15 minutes; B limit is 12 m/s.\n\n## Drone Profiles\n- Drone A: {'role': 'medical_emergency', 'distance_km': 5, 'deadline_min': 30}\n- Drone B: {'role': 'commercial_delivery', 'distance_km': 3, 'deadline_min': 45, 'wind_limit_ms': 12}\n- Drone C: {'role': 'infrastructure_inspection', 'distance_km': 2, 'deadline_min': None}\n\n## Global Rules\n- R1: medical > commercial > inspection\n- R2: single drone per corridor (500m spacing)\n- R3: B wind limit 12 m/s\n- R4: 15% battery reserve\n\n## Current Conditions\n- Current wind 8 m/s\n- Forecast 14 m/s at +15 min\n- B needs 12 min round trip\n\n---\n\n## Output Requirements\n1. **Decision**: Provide a JSON object with per-drone allocations (e.g., immediate launch, delay X minutes, reroute, reject).\n2. **Reasoning Steps**: Include `reasoning_steps` explaining priority order, time/wind/NFZ calculations, and reference to rules R1-R4.\n3. **Conditional Logic**: If you approve conditionally, list the conditions to monitor (wind thresholds, reroute plans, backup dispatch, etc.).\n4. **Time/Battery Math**: Show calculations when rejecting (e.g., total minutes exceed deadline) or when windows are tight.\n5. **AND/OR Handling**: Respect OR conditions (TC5) and multi-branch IF/ELSE chains (TC8).\n6. **Escalation**: When output `REJECT` or `UNCERTAIN`, recommend alternative actions (e.g., dispatch backup UAV).\n\nReturn JSON such as:\n```json\n{\n  \"decision\": \"CONDITIONAL_APPROVE\",\n  \"allocations\": [\n    {\"drone\": \"A\", \"action\": \"launch_now\"},\n    {\"drone\": \"B\", \"action\": \"launch_after\", \"delay_min\": 5},\n    {\"drone\": \"C\", \"action\": \"delay\", \"delay_min\": 15}\n  ],\n  \"conditions\": [\n    \"Abort B if wind >= 14 m/s before completion\",\n    \"Monitor NFZ activation time\"\n  ],\n  \"reasoning_steps\": [\n    \"Step1...\",\n    \"Step2...\"\n  ]\n}\n```\n\n\n# Retrieved Evidence\n\n\n(no constraints found)\nDecision rule: Respect priority ordering and spacing; monitor wind/charging/NFZ dynamics. If wind/charging constraints risk reserve or delay, prefer CONDITIONAL_APPROVE with monitoring or REJECT if infeasible. Temporary NFZ requires reroute or waiver; without it, do not approve a plan that violates NFZ. If charging delay blocks schedule, REJECT unless a viable staggered plan is provided.\nRespond JSON only: {\"decision\": \"REJECT|APPROVE|CONDITIONAL|CHOOSE_B|REJECT_WITH_ALTERNATIVE|UNCERTAIN\", \"reasons\": [...], \"citations\": [...], \"evidence_used\": [...]}. Cite option/waiver/priority fields when relevant.",
      "llm_raw": "```json\n{\n  \"decision\": \"CONDITIONAL_APPROVE\",\n  \"allocations\": [\n    {\"drone\": \"A\", \"action\": \"launch_now\"},\n    {\"drone\": \"B\", \"action\": \"reject\"},\n    {\"drone\": \"C\", \"action\": \"reject\"}\n  ],\n  \"conditions\": [\n    \"Monitor wind conditions throughout Drone A's mission, especially as it approaches 14 m/s at +15 minutes and potentially higher thereafter.\"\n  ],\n  \"reasoning_steps\": [\n    \"1. **Calculate Drone Speeds and Round Trip Times**: Based on Drone B's requirement of a 12-minute round trip for 3 km, the assumed operational speed is 3 km / 6 min (one way) = 0.5 km/min (30 km/h).\",\n    \"   - Drone A: 5 km distance -> 10 min one-way -> 20 min round trip.\",\n    \"   - Drone B: 3 km distance -> 6 min one-way -> 12 min round trip (matches scenario info).\",\n    \"   - Drone C: 2 km distance -> 4 min one-way -> 8 min round trip.\",\n    \"2. **Determine Wind Increase Rate**: Current wind is 8 m/s, rising to 14 m/s in 15 minutes. The linear increase rate is (14 m/s - 8 m/s) / 15 min = 6 m/s / 15 min = 0.4 m/s per minute. Wind at time 't' will be `W(t) = 8 + 0.4 * t`.\",\n    \"3. **Prioritize Drones (R1)**: Medical emergency (A) > Commercial delivery (B) > Infrastructure inspection (C).\",\n    \"4. **Evaluate Drone A (Medical Emergency)**:\",\n    \"   - Priority: Highest.\",\n    \"   - Action: `launch_now`. Its mission is critical. Round trip time is 20 minutes.\",\n    \"   - Wind during mission: Launches at 8 m/s. Returns at t=20 min. Wind at t=20 min = 8 + (0.4 * 20) = 8 + 8 = 16 m/s. Although this is higher than the explicit 14 m/s forecast at +15 min, for a medical emergency with no specified wind limit, the mission is assumed to proceed, possibly with higher operational tolerance or overriding urgency. Deadline of 30 min is comfortably met (20 min flight).\",\n    \"5. **Evaluate Drone B (Commercial Delivery)**:\",\n    \"   - Priority: Medium.\",\n    \"   - Rule (R3): Wind limit is 12 m/s.\",\n    \"   - Mission Duration: 12 minutes round trip.\",\n    \"   - Calculation for wind limit: Determine when the wind will reach 12 m/s: `8 + 0.4 * t = 12` -> `0.4 * t = 4` -> `t = 10 minutes`. This means at `t=10 min`, the wind will be 12 m/s. After 10 minutes, the wind will exceed 12 m/s.\",\n    \"   - Feasibility check: Drone B needs 12 minutes for its mission. To safely complete its mission within the 12 m/s wind limit, it must return by `t=10 min`. This implies it would need to launch at `10 min - 12 min = -2 min` (i.e., 2 minutes ago). Since it cannot launch now (t=0) and complete its mission before the wind limit is breached, Drone B must be rejected.\",\n    \"6. **Evaluate Drone C (Infrastructure Inspection)**:\",\n    \"   - Priority: Lowest. No deadline.\",\n    \"   - Wind Limit Assumption: Since C is for inspection and has no specified limit, it's reasonable to assume it has a wind tolerance at or below commercial delivery drones. Let's assume a conservative wind limit of 10 m/s for C, making it more sensitive than Drone B (12 m/s).\",\n    \"   - Mission Duration: 8 minutes round trip.\",\n    \"   - Calculation for wind limit: Determine when the wind will reach 10 m/s: `8 + 0.4 * t = 10` -> `0.4 * t = 2` -> `t = 5 minutes`. At `t=5 min`, the wind will be 10 m/s. After 5 minutes, the wind will exceed 10 m/s.\",\n    \"   - Feasibility check: Drone C needs 8 minutes for its mission. To safely complete its mission within its assumed 10 m/s wind limit, it must return by `t=5 min`. This implies it would need to launch at `5 min - 8 min = -3 min` (i.e., 3 minutes ago). Since it cannot launch now (t=0) and complete its mission before its assumed wind limit is breached, Drone C must be rejected.\",\n    \"7. **Corridor Rule (R2)**: 'single drone per corridor (500m spacing)'. With B and C rejected, only Drone A is active, so this rule is not violated for simultaneous operations (only A is flying).\"\n  ],\n  \"escalation\": \"For Drone B and C, recommend re-evaluating mission priority and feasibility under future improved wind conditions, or considering alternative assets/methods (e.g., ground transport, backup UAVs with higher wind tolerance if available and within budget).\"\n}\n```",
      "llm_parsed": {
        "decision": "CONDITIONAL_APPROVE",
        "allocations": [
          {
            "drone": "A",
            "action": "launch_now"
          },
          {
            "drone": "B",
            "action": "reject"
          },
          {
            "drone": "C",
            "action": "reject"
          }
        ],
        "conditions": [
          "Monitor wind conditions throughout Drone A's mission, especially as it approaches 14 m/s at +15 minutes and potentially higher thereafter."
        ],
        "reasoning_steps": [
          "1. **Calculate Drone Speeds and Round Trip Times**: Based on Drone B's requirement of a 12-minute round trip for 3 km, the assumed operational speed is 3 km / 6 min (one way) = 0.5 km/min (30 km/h).",
          "   - Drone A: 5 km distance -> 10 min one-way -> 20 min round trip.",
          "   - Drone B: 3 km distance -> 6 min one-way -> 12 min round trip (matches scenario info).",
          "   - Drone C: 2 km distance -> 4 min one-way -> 8 min round trip.",
          "2. **Determine Wind Increase Rate**: Current wind is 8 m/s, rising to 14 m/s in 15 minutes. The linear increase rate is (14 m/s - 8 m/s) / 15 min = 6 m/s / 15 min = 0.4 m/s per minute. Wind at time 't' will be `W(t) = 8 + 0.4 * t`.",
          "3. **Prioritize Drones (R1)**: Medical emergency (A) > Commercial delivery (B) > Infrastructure inspection (C).",
          "4. **Evaluate Drone A (Medical Emergency)**:",
          "   - Priority: Highest.",
          "   - Action: `launch_now`. Its mission is critical. Round trip time is 20 minutes.",
          "   - Wind during mission: Launches at 8 m/s. Returns at t=20 min. Wind at t=20 min = 8 + (0.4 * 20) = 8 + 8 = 16 m/s. Although this is higher than the explicit 14 m/s forecast at +15 min, for a medical emergency with no specified wind limit, the mission is assumed to proceed, possibly with higher operational tolerance or overriding urgency. Deadline of 30 min is comfortably met (20 min flight).",
          "5. **Evaluate Drone B (Commercial Delivery)**:",
          "   - Priority: Medium.",
          "   - Rule (R3): Wind limit is 12 m/s.",
          "   - Mission Duration: 12 minutes round trip.",
          "   - Calculation for wind limit: Determine when the wind will reach 12 m/s: `8 + 0.4 * t = 12` -> `0.4 * t = 4` -> `t = 10 minutes`. This means at `t=10 min`, the wind will be 12 m/s. After 10 minutes, the wind will exceed 12 m/s.",
          "   - Feasibility check: Drone B needs 12 minutes for its mission. To safely complete its mission within the 12 m/s wind limit, it must return by `t=10 min`. This implies it would need to launch at `10 min - 12 min = -2 min` (i.e., 2 minutes ago). Since it cannot launch now (t=0) and complete its mission before the wind limit is breached, Drone B must be rejected.",
          "6. **Evaluate Drone C (Infrastructure Inspection)**:",
          "   - Priority: Lowest. No deadline.",
          "   - Wind Limit Assumption: Since C is for inspection and has no specified limit, it's reasonable to assume it has a wind tolerance at or below commercial delivery drones. Let's assume a conservative wind limit of 10 m/s for C, making it more sensitive than Drone B (12 m/s).",
          "   - Mission Duration: 8 minutes round trip.",
          "   - Calculation for wind limit: Determine when the wind will reach 10 m/s: `8 + 0.4 * t = 10` -> `0.4 * t = 2` -> `t = 5 minutes`. At `t=5 min`, the wind will be 10 m/s. After 5 minutes, the wind will exceed 10 m/s.",
          "   - Feasibility check: Drone C needs 8 minutes for its mission. To safely complete its mission within its assumed 10 m/s wind limit, it must return by `t=5 min`. This implies it would need to launch at `5 min - 8 min = -3 min` (i.e., 3 minutes ago). Since it cannot launch now (t=0) and complete its mission before its assumed wind limit is breached, Drone C must be rejected.",
          "7. **Corridor Rule (R2)**: 'single drone per corridor (500m spacing)'. With B and C rejected, only Drone A is active, so this rule is not violated for simultaneous operations (only A is flying)."
        ],
        "escalation": "For Drone B and C, recommend re-evaluating mission priority and feasibility under future improved wind conditions, or considering alternative assets/methods (e.g., ground transport, backup UAVs with higher wind tolerance if available and within budget)."
      },
      "mission": {},
      "retrieved_constraints": []
    },
    {
      "test_case_id": "TC3_TemporaryNFZ",
      "description": "A+B corridor blocked 10 min from now for 15 min.",
      "expected_decision": "CONDITIONAL_APPROVE",
      "llm_decision": "CONDITIONAL_APPROVE",
      "prompt": "# UTM Dynamic Scheduling Decision\n\n## Scenario Info\n- Scenario ID: S030\n- Test Case: TC3_TemporaryNFZ\n- Description: A+B corridor blocked 10 min from now for 15 min.\n\n## Drone Profiles\n- Drone A: {'role': 'medical_emergency', 'distance_km': 5, 'deadline_min': 30}\n- Drone B: {'role': 'commercial_delivery', 'distance_km': 3, 'deadline_min': 45, 'wind_limit_ms': 12}\n- Drone C: {'role': 'infrastructure_inspection', 'distance_km': 2, 'deadline_min': None}\n\n## Global Rules\n- R1: medical > commercial > inspection\n- R2: single drone per corridor (500m spacing)\n- R3: B wind limit 12 m/s\n- R4: 15% battery reserve\n\n## Current Conditions\n- NFZ starts in 10 min\n- A flight time 15 min\n- B flight time 9 min\n\n---\n\n## Output Requirements\n1. **Decision**: Provide a JSON object with per-drone allocations (e.g., immediate launch, delay X minutes, reroute, reject).\n2. **Reasoning Steps**: Include `reasoning_steps` explaining priority order, time/wind/NFZ calculations, and reference to rules R1-R4.\n3. **Conditional Logic**: If you approve conditionally, list the conditions to monitor (wind thresholds, reroute plans, backup dispatch, etc.).\n4. **Time/Battery Math**: Show calculations when rejecting (e.g., total minutes exceed deadline) or when windows are tight.\n5. **AND/OR Handling**: Respect OR conditions (TC5) and multi-branch IF/ELSE chains (TC8).\n6. **Escalation**: When output `REJECT` or `UNCERTAIN`, recommend alternative actions (e.g., dispatch backup UAV).\n\nReturn JSON such as:\n```json\n{\n  \"decision\": \"CONDITIONAL_APPROVE\",\n  \"allocations\": [\n    {\"drone\": \"A\", \"action\": \"launch_now\"},\n    {\"drone\": \"B\", \"action\": \"launch_after\", \"delay_min\": 5},\n    {\"drone\": \"C\", \"action\": \"delay\", \"delay_min\": 15}\n  ],\n  \"conditions\": [\n    \"Abort B if wind >= 14 m/s before completion\",\n    \"Monitor NFZ activation time\"\n  ],\n  \"reasoning_steps\": [\n    \"Step1...\",\n    \"Step2...\"\n  ]\n}\n```\n\n\n# Retrieved Evidence\n\n\n(no constraints found)\nDecision rule: Respect priority ordering and spacing; monitor wind/charging/NFZ dynamics. If wind/charging constraints risk reserve or delay, prefer CONDITIONAL_APPROVE with monitoring or REJECT if infeasible. Temporary NFZ requires reroute or waiver; without it, do not approve a plan that violates NFZ. If charging delay blocks schedule, REJECT unless a viable staggered plan is provided.\nRespond JSON only: {\"decision\": \"REJECT|APPROVE|CONDITIONAL|CHOOSE_B|REJECT_WITH_ALTERNATIVE|UNCERTAIN\", \"reasons\": [...], \"citations\": [...], \"evidence_used\": [...]}. Cite option/waiver/priority fields when relevant.",
      "llm_raw": "```json\n{\n  \"decision\": \"CONDITIONAL_APPROVE\",\n  \"allocations\": [\n    {\n      \"drone\": \"A\",\n      \"action\": \"reroute\",\n      \"delay_min\": 0\n    },\n    {\n      \"drone\": \"B\",\n      \"action\": \"launch_now\"\n    },\n    {\n      \"drone\": \"C\",\n      \"action\": \"delay\",\n      \"delay_min\": 25\n    }\n  ],\n  \"conditions\": [\n    \"Drone A's reroute path must be identified and confirmed to ensure completion within the 30-minute deadline and avoid the NFZ.\",\n    \"Monitor wind conditions for Drone B; if wind exceeds 12 m/s at launch or during flight, the mission must be aborted or reconsidered (R3).\"\n  ],\n  \"reasoning_steps\": [\n    \"1.  **Prioritization (R1)**: Establish drone priority: Drone A (medical_emergency) > Drone B (commercial_delivery) > Drone C (infrastructure_inspection).\",\n    \"2.  **Evaluate Drone A (Medical Emergency)**:\",\n    \"    *   Flight time: 15 min. Deadline: 30 min. NFZ: Starts in 10 min (t=10) and lasts for 15 min (until t=25), blocking the A+B corridor.\",\n    \"    *   **If launched now (t=0)**: Drone A would fly from t=0 to t=15. The NFZ is active from t=10 to t=25. This means Drone A would be in conflict with the NFZ from t=10 to t=15. This violates the rule: 'do not approve a plan that violates NFZ'.\",\n    \"    *   **If delayed until NFZ ends (launch at t=25)**: Drone A would fly from t=25 to t=40. This exceeds its 30-minute deadline (40 min > 30 min).\",\n    \"    *   **Conclusion for A**: Neither launching now nor delaying is feasible with the current flight plan. As a medical emergency (highest priority), the 'Retrieved Evidence' rule states: 'Temporary NFZ requires reroute or waiver'. Therefore, the required action for Drone A is to `reroute` to avoid the NFZ. This action is conditionally approved, requiring confirmation that the reroute path allows completion within the 30-minute deadline.\",\n    \"3.  **Evaluate Drone B (Commercial Delivery)**:\",\n    \"    *   Flight time: 9 min. Deadline: 45 min. Wind limit: 12 m/s (R3). NFZ: Starts in 10 min (t=10).\",\n    \"    *   **If launched now (t=0)**: Drone B would fly from t=0 to t=9. This means it completes its mission and clears the corridor 1 minute *before* the NFZ activates at t=10.\",\n    \"    *   No NFZ violation. Well within the 45-minute deadline (9 min < 45 min).\",\n    \"    *   **Corridor Spacing (R2)**: Since Drone B completes before the NFZ starts and Drone A is rerouting, there is no concurrent corridor conflict.\",\n    \"    *   **Conclusion for B**: `launch_now` is approved, with a condition to monitor wind (R3).\",\n    \"4.  **Evaluate Drone C (Infrastructure Inspection)**:\",\n    \"    *   Distance: 2 km. Flight time: Not provided, **ASSUMED 6 min** (based on ~3 min/km rate from A and B). Deadline: None. NFZ: Affects 'A+B corridor'; assumed C's corridor is not affected.\",\n    \"    *   As the lowest priority drone (R1) with no deadline, it is prudent to `delay` its launch to provide flexibility and allow higher-priority operations (A's reroute, B's launch) to proceed or resolve their issues first.\",\n    \"    *   Delaying until after the NFZ concludes (t=25) ensures clear airspace and no potential conflicts with the dynamic rerouting of Drone A. If launched at t=25, it would land at t=31 (assuming 6 min flight time).\",\n    \"    *   **Conclusion for C**: `delay 25 minutes` is approved, providing maximum operational flexibility.\"\n  ]\n}\n```",
      "llm_parsed": {
        "decision": "CONDITIONAL_APPROVE",
        "allocations": [
          {
            "drone": "A",
            "action": "reroute",
            "delay_min": 0
          },
          {
            "drone": "B",
            "action": "launch_now"
          },
          {
            "drone": "C",
            "action": "delay",
            "delay_min": 25
          }
        ],
        "conditions": [
          "Drone A's reroute path must be identified and confirmed to ensure completion within the 30-minute deadline and avoid the NFZ.",
          "Monitor wind conditions for Drone B; if wind exceeds 12 m/s at launch or during flight, the mission must be aborted or reconsidered (R3)."
        ],
        "reasoning_steps": [
          "1.  **Prioritization (R1)**: Establish drone priority: Drone A (medical_emergency) > Drone B (commercial_delivery) > Drone C (infrastructure_inspection).",
          "2.  **Evaluate Drone A (Medical Emergency)**:",
          "    *   Flight time: 15 min. Deadline: 30 min. NFZ: Starts in 10 min (t=10) and lasts for 15 min (until t=25), blocking the A+B corridor.",
          "    *   **If launched now (t=0)**: Drone A would fly from t=0 to t=15. The NFZ is active from t=10 to t=25. This means Drone A would be in conflict with the NFZ from t=10 to t=15. This violates the rule: 'do not approve a plan that violates NFZ'.",
          "    *   **If delayed until NFZ ends (launch at t=25)**: Drone A would fly from t=25 to t=40. This exceeds its 30-minute deadline (40 min > 30 min).",
          "    *   **Conclusion for A**: Neither launching now nor delaying is feasible with the current flight plan. As a medical emergency (highest priority), the 'Retrieved Evidence' rule states: 'Temporary NFZ requires reroute or waiver'. Therefore, the required action for Drone A is to `reroute` to avoid the NFZ. This action is conditionally approved, requiring confirmation that the reroute path allows completion within the 30-minute deadline.",
          "3.  **Evaluate Drone B (Commercial Delivery)**:",
          "    *   Flight time: 9 min. Deadline: 45 min. Wind limit: 12 m/s (R3). NFZ: Starts in 10 min (t=10).",
          "    *   **If launched now (t=0)**: Drone B would fly from t=0 to t=9. This means it completes its mission and clears the corridor 1 minute *before* the NFZ activates at t=10.",
          "    *   No NFZ violation. Well within the 45-minute deadline (9 min < 45 min).",
          "    *   **Corridor Spacing (R2)**: Since Drone B completes before the NFZ starts and Drone A is rerouting, there is no concurrent corridor conflict.",
          "    *   **Conclusion for B**: `launch_now` is approved, with a condition to monitor wind (R3).",
          "4.  **Evaluate Drone C (Infrastructure Inspection)**:",
          "    *   Distance: 2 km. Flight time: Not provided, **ASSUMED 6 min** (based on ~3 min/km rate from A and B). Deadline: None. NFZ: Affects 'A+B corridor'; assumed C's corridor is not affected.",
          "    *   As the lowest priority drone (R1) with no deadline, it is prudent to `delay` its launch to provide flexibility and allow higher-priority operations (A's reroute, B's launch) to proceed or resolve their issues first.",
          "    *   Delaying until after the NFZ concludes (t=25) ensures clear airspace and no potential conflicts with the dynamic rerouting of Drone A. If launched at t=25, it would land at t=31 (assuming 6 min flight time).",
          "    *   **Conclusion for C**: `delay 25 minutes` is approved, providing maximum operational flexibility."
        ]
      },
      "mission": {},
      "retrieved_constraints": []
    },
    {
      "test_case_id": "TC4_ChargingStation",
      "description": "A must charge but station free in 20 min.",
      "expected_decision": "REJECT",
      "llm_decision": "CONDITIONAL_APPROVE",
      "prompt": "# UTM Dynamic Scheduling Decision\n\n## Scenario Info\n- Scenario ID: S030\n- Test Case: TC4_ChargingStation\n- Description: A must charge but station free in 20 min.\n\n## Drone Profiles\n- Drone A: {'role': 'medical_emergency', 'distance_km': 5, 'deadline_min': 30}\n- Drone B: {'role': 'commercial_delivery', 'distance_km': 3, 'deadline_min': 45, 'wind_limit_ms': 12}\n- Drone C: {'role': 'infrastructure_inspection', 'distance_km': 2, 'deadline_min': None}\n\n## Global Rules\n- R1: medical > commercial > inspection\n- R2: single drone per corridor (500m spacing)\n- R3: B wind limit 12 m/s\n- R4: 15% battery reserve\n\n## Current Conditions\n- A battery 40% (needs 55%)\n- Charge takes 15 min plus 20 min wait\n- Mission deadline 30 min\n\n---\n\n## Output Requirements\n1. **Decision**: Provide a JSON object with per-drone allocations (e.g., immediate launch, delay X minutes, reroute, reject).\n2. **Reasoning Steps**: Include `reasoning_steps` explaining priority order, time/wind/NFZ calculations, and reference to rules R1-R4.\n3. **Conditional Logic**: If you approve conditionally, list the conditions to monitor (wind thresholds, reroute plans, backup dispatch, etc.).\n4. **Time/Battery Math**: Show calculations when rejecting (e.g., total minutes exceed deadline) or when windows are tight.\n5. **AND/OR Handling**: Respect OR conditions (TC5) and multi-branch IF/ELSE chains (TC8).\n6. **Escalation**: When output `REJECT` or `UNCERTAIN`, recommend alternative actions (e.g., dispatch backup UAV).\n\nReturn JSON such as:\n```json\n{\n  \"decision\": \"CONDITIONAL_APPROVE\",\n  \"allocations\": [\n    {\"drone\": \"A\", \"action\": \"launch_now\"},\n    {\"drone\": \"B\", \"action\": \"launch_after\", \"delay_min\": 5},\n    {\"drone\": \"C\", \"action\": \"delay\", \"delay_min\": 15}\n  ],\n  \"conditions\": [\n    \"Abort B if wind >= 14 m/s before completion\",\n    \"Monitor NFZ activation time\"\n  ],\n  \"reasoning_steps\": [\n    \"Step1...\",\n    \"Step2...\"\n  ]\n}\n```\n\n\n# Retrieved Evidence\n\n\n(no constraints found)\nDecision rule: Respect priority ordering and spacing; monitor wind/charging/NFZ dynamics. If wind/charging constraints risk reserve or delay, prefer CONDITIONAL_APPROVE with monitoring or REJECT if infeasible. Temporary NFZ requires reroute or waiver; without it, do not approve a plan that violates NFZ. If charging delay blocks schedule, REJECT unless a viable staggered plan is provided.\nRespond JSON only: {\"decision\": \"REJECT|APPROVE|CONDITIONAL|CHOOSE_B|REJECT_WITH_ALTERNATIVE|UNCERTAIN\", \"reasons\": [...], \"citations\": [...], \"evidence_used\": [...]}. Cite option/waiver/priority fields when relevant.",
      "llm_raw": "```json\n{\n  \"decision\": \"CONDITIONAL_APPROVE\",\n  \"allocations\": [\n    {\"drone\": \"A\", \"action\": \"reject\"},\n    {\"drone\": \"B\", \"action\": \"launch_now\"},\n    {\"drone\": \"C\", \"action\": \"delay\", \"delay_min\": 5}\n  ],\n  \"conditions\": [\n    \"Monitor wind speed for Drone B; abort mission if wind exceeds 12 m/s.\"\n  ],\n  \"reasoning_steps\": [\n    \"1. **Prioritization (R1)**: Drones are prioritized as follows: Drone A (medical_emergency) > Drone B (commercial_delivery) > Drone C (infrastructure_inspection).\",\n    \"2. **Evaluate Drone A (medical_emergency)**:\",\n    \"   - Required battery: 55%. Current battery: 40%. Drone A requires charging.\",\n    \"   - Charging time: 15 minutes. Wait for charging station: 20 minutes.\",\n    \"   - Total time until Drone A is ready to launch = 20 min (wait) + 15 min (charge) = 35 minutes.\",\n    \"   - Mission deadline: 30 minutes.\",\n    \"   - **Time Math**: The ready-to-launch time (35 min) exceeds the mission deadline (30 min). Therefore, Drone A cannot complete its mission within the stipulated deadline.\",\n    \"   - **Decision for A**: REJECT. This mission cannot be fulfilled by Drone A under current conditions.\",\n    \"3. **Alternative for Drone A**: Recommend dispatching a backup UAV or finding an alternative charging solution that allows for immediate or faster charging to meet the critical deadline.\",\n    \"4. **Evaluate Drone B (commercial_delivery)**:\",\n    \"   - Next highest priority after Drone A's rejection.\",\n    \"   - Distance: 3 km. Assuming an average drone speed of ~36 km/h (0.6 km/min), the flight time would be approximately 3 km / 0.6 km/min = 5 minutes. This is well within its 45-minute deadline.\",\n    \"   - **Wind Limit (R3)**: Drone B has a wind limit of 12 m/s. Current wind conditions are not provided.\",\n    \"   - **Decision for B**: CONDITIONAL_APPROVE. Launch immediately, but monitor wind conditions.\",\n    \"5. **Evaluate Drone C (infrastructure_inspection)**:\",\n    \"   - Lowest priority and no specific deadline.\",\n    \"   - **Corridor Rule (R2)**: Only one drone is allowed per corridor (500m spacing). Since Drone B is cleared for immediate launch, Drone C must wait for Drone B to clear the corridor.\",\n    \"   - Assuming Drone B's mission takes approximately 5 minutes, Drone C can be scheduled to launch after Drone B has completed its mission and the corridor is clear. A 5-minute delay from now (assuming B launches now and clears corridor by then) is appropriate.\",\n    \"   - **Decision for C**: DELAY, with a delay of 5 minutes until Drone B's corridor is clear.\"\n  ]\n}\n```",
      "llm_parsed": {
        "decision": "CONDITIONAL_APPROVE",
        "allocations": [
          {
            "drone": "A",
            "action": "reject"
          },
          {
            "drone": "B",
            "action": "launch_now"
          },
          {
            "drone": "C",
            "action": "delay",
            "delay_min": 5
          }
        ],
        "conditions": [
          "Monitor wind speed for Drone B; abort mission if wind exceeds 12 m/s."
        ],
        "reasoning_steps": [
          "1. **Prioritization (R1)**: Drones are prioritized as follows: Drone A (medical_emergency) > Drone B (commercial_delivery) > Drone C (infrastructure_inspection).",
          "2. **Evaluate Drone A (medical_emergency)**:",
          "   - Required battery: 55%. Current battery: 40%. Drone A requires charging.",
          "   - Charging time: 15 minutes. Wait for charging station: 20 minutes.",
          "   - Total time until Drone A is ready to launch = 20 min (wait) + 15 min (charge) = 35 minutes.",
          "   - Mission deadline: 30 minutes.",
          "   - **Time Math**: The ready-to-launch time (35 min) exceeds the mission deadline (30 min). Therefore, Drone A cannot complete its mission within the stipulated deadline.",
          "   - **Decision for A**: REJECT. This mission cannot be fulfilled by Drone A under current conditions.",
          "3. **Alternative for Drone A**: Recommend dispatching a backup UAV or finding an alternative charging solution that allows for immediate or faster charging to meet the critical deadline.",
          "4. **Evaluate Drone B (commercial_delivery)**:",
          "   - Next highest priority after Drone A's rejection.",
          "   - Distance: 3 km. Assuming an average drone speed of ~36 km/h (0.6 km/min), the flight time would be approximately 3 km / 0.6 km/min = 5 minutes. This is well within its 45-minute deadline.",
          "   - **Wind Limit (R3)**: Drone B has a wind limit of 12 m/s. Current wind conditions are not provided.",
          "   - **Decision for B**: CONDITIONAL_APPROVE. Launch immediately, but monitor wind conditions.",
          "5. **Evaluate Drone C (infrastructure_inspection)**:",
          "   - Lowest priority and no specific deadline.",
          "   - **Corridor Rule (R2)**: Only one drone is allowed per corridor (500m spacing). Since Drone B is cleared for immediate launch, Drone C must wait for Drone B to clear the corridor.",
          "   - Assuming Drone B's mission takes approximately 5 minutes, Drone C can be scheduled to launch after Drone B has completed its mission and the corridor is clear. A 5-minute delay from now (assuming B launches now and clears corridor by then) is appropriate.",
          "   - **Decision for C**: DELAY, with a delay of 5 minutes until Drone B's corridor is clear."
        ]
      },
      "mission": {},
      "retrieved_constraints": []
    },
    {
      "test_case_id": "TC5_ORLogic",
      "description": "Approval if wind <12 m/s OR waiver granted.",
      "expected_decision": "APPROVE",
      "llm_decision": "CONDITIONAL_APPROVE",
      "prompt": "# UTM Dynamic Scheduling Decision\n\n## Scenario Info\n- Scenario ID: S030\n- Test Case: TC5_ORLogic\n- Description: Approval if wind <12 m/s OR waiver granted.\n\n## Drone Profiles\n- Drone A: {'role': 'medical_emergency', 'distance_km': 5, 'deadline_min': 30}\n- Drone B: {'role': 'commercial_delivery', 'distance_km': 3, 'deadline_min': 45, 'wind_limit_ms': 12}\n- Drone C: {'role': 'infrastructure_inspection', 'distance_km': 2, 'deadline_min': None}\n\n## Global Rules\n- R1: medical > commercial > inspection\n- R2: single drone per corridor (500m spacing)\n- R3: B wind limit 12 m/s\n- R4: 15% battery reserve\n\n## Current Conditions\n- Current wind 8 m/s\n- Waiver not requested\n\n---\n\n## Output Requirements\n1. **Decision**: Provide a JSON object with per-drone allocations (e.g., immediate launch, delay X minutes, reroute, reject).\n2. **Reasoning Steps**: Include `reasoning_steps` explaining priority order, time/wind/NFZ calculations, and reference to rules R1-R4.\n3. **Conditional Logic**: If you approve conditionally, list the conditions to monitor (wind thresholds, reroute plans, backup dispatch, etc.).\n4. **Time/Battery Math**: Show calculations when rejecting (e.g., total minutes exceed deadline) or when windows are tight.\n5. **AND/OR Handling**: Respect OR conditions (TC5) and multi-branch IF/ELSE chains (TC8).\n6. **Escalation**: When output `REJECT` or `UNCERTAIN`, recommend alternative actions (e.g., dispatch backup UAV).\n\nReturn JSON such as:\n```json\n{\n  \"decision\": \"CONDITIONAL_APPROVE\",\n  \"allocations\": [\n    {\"drone\": \"A\", \"action\": \"launch_now\"},\n    {\"drone\": \"B\", \"action\": \"launch_after\", \"delay_min\": 5},\n    {\"drone\": \"C\", \"action\": \"delay\", \"delay_min\": 15}\n  ],\n  \"conditions\": [\n    \"Abort B if wind >= 14 m/s before completion\",\n    \"Monitor NFZ activation time\"\n  ],\n  \"reasoning_steps\": [\n    \"Step1...\",\n    \"Step2...\"\n  ]\n}\n```\n\n\n# Retrieved Evidence\n\n\n(no constraints found)\nDecision rule: Respect priority ordering and spacing; monitor wind/charging/NFZ dynamics. If wind/charging constraints risk reserve or delay, prefer CONDITIONAL_APPROVE with monitoring or REJECT if infeasible. Temporary NFZ requires reroute or waiver; without it, do not approve a plan that violates NFZ. If charging delay blocks schedule, REJECT unless a viable staggered plan is provided.\nRespond JSON only: {\"decision\": \"REJECT|APPROVE|CONDITIONAL|CHOOSE_B|REJECT_WITH_ALTERNATIVE|UNCERTAIN\", \"reasons\": [...], \"citations\": [...], \"evidence_used\": [...]}. Cite option/waiver/priority fields when relevant.",
      "llm_raw": "```json\n{\n  \"decision\": \"CONDITIONAL_APPROVE\",\n  \"allocations\": [\n    {\"drone\": \"A\", \"action\": \"launch_now\"},\n    {\"drone\": \"B\", \"action\": \"launch_now\"},\n    {\"drone\": \"C\", \"action\": \"launch_now\"}\n  ],\n  \"conditions\": [\n    \"Monitor wind for Drone B: abort mission if wind speed reaches or exceeds 12 m/s during flight.\"\n  ],\n  \"reasoning_steps\": [\n    \"Step 1: Prioritize drones based on Global Rule R1 (medical > commercial > inspection). Order: Drone A, Drone B, Drone C.\",\n    \"Step 2: Evaluate Drone A (Medical Emergency - Highest Priority).\",\n    \"  - Role: medical_emergency. Distance: 5 km. Deadline: 30 min.\",\n    \"  - Assuming an average drone speed of 0.6 km/min (10 m/s), one-way flight time is 5 km / 0.6 km/min = 8.33 min. Round trip is approximately 16.66 minutes, which is well within the 30-minute deadline.\",\n    \"  - No specific wind limit for Drone A. Current wind of 8 m/s is not a concern.\",\n    \"  - Global Rule R4 (15% battery reserve): Given the short flight time, it's assumed this requirement is met based on typical drone capabilities for this distance.\",\n    \"  - Decision for A: All conditions met. Allocate `launch_now`.\",\n    \"Step 3: Evaluate Drone B (Commercial Delivery - Second Priority).\",\n    \"  - Role: commercial_delivery. Distance: 3 km. Deadline: 45 min.\",\n    \"  - Global Rule R3: Wind limit is 12 m/s. Current wind is 8 m/s. The decision rule 'Approval if wind <12 m/s OR waiver granted' (TC5_ORLogic) is met because 8 m/s is less than 12 m/s. Waiver is not needed and not requested.\",\n    \"  - Flight time for 3 km (at 0.6 km/min) is 5 min one-way, ~10 min round trip, well within the 45-minute deadline.\",\n    \"  - Global Rule R4 (15% battery reserve): Assumed met for this distance.\",\n    \"  - Decision for B: All conditions met, but due to the dynamic nature of wind, a monitoring condition is prudent. Allocate `launch_now`.\",\n    \"Step 4: Evaluate Drone C (Infrastructure Inspection - Lowest Priority).\",\n    \"  - Role: infrastructure_inspection. Distance: 2 km. Deadline: None.\",\n    \"  - Flight time for 2 km (at 0.6 km/min) is 3.33 min one-way, ~6.66 min round trip.\",\n    \"  - No specific wind limit for Drone C. Current wind of 8 m/s is not a concern.\",\n    \"  - Global Rule R4 (15% battery reserve): Assumed met for this distance.\",\n    \"  - Decision for C: All conditions met. Allocate `launch_now`.\",\n    \"Step 5: Address Global Rule R2 (single drone per corridor, 500m spacing).\",\n    \"  - The scenario does not specify if the drones share a single corridor or if multiple corridors are available. Given the rule is 'single drone *per corridor*', it is assumed that separate corridors are available for these distinct missions, allowing concurrent launch for all three drones without violating the rule. If a single shared corridor were implied, a sequential launch based on priority would be necessary, but this is not specified.\",\n    \"Step 6: Final Decision and Conditions.\",\n    \"  - All drones meet their respective requirements for immediate launch. However, to account for potential changes in environmental conditions, specifically wind speed affecting Drone B's operation (R3), a monitoring condition is recommended.\",\n    \"  - Therefore, the decision is `CONDITIONAL_APPROVE` with a condition to monitor wind for Drone B throughout its mission.\"\n  ]\n}\n```",
      "llm_parsed": {
        "decision": "CONDITIONAL_APPROVE",
        "allocations": [
          {
            "drone": "A",
            "action": "launch_now"
          },
          {
            "drone": "B",
            "action": "launch_now"
          },
          {
            "drone": "C",
            "action": "launch_now"
          }
        ],
        "conditions": [
          "Monitor wind for Drone B: abort mission if wind speed reaches or exceeds 12 m/s during flight."
        ],
        "reasoning_steps": [
          "Step 1: Prioritize drones based on Global Rule R1 (medical > commercial > inspection). Order: Drone A, Drone B, Drone C.",
          "Step 2: Evaluate Drone A (Medical Emergency - Highest Priority).",
          "  - Role: medical_emergency. Distance: 5 km. Deadline: 30 min.",
          "  - Assuming an average drone speed of 0.6 km/min (10 m/s), one-way flight time is 5 km / 0.6 km/min = 8.33 min. Round trip is approximately 16.66 minutes, which is well within the 30-minute deadline.",
          "  - No specific wind limit for Drone A. Current wind of 8 m/s is not a concern.",
          "  - Global Rule R4 (15% battery reserve): Given the short flight time, it's assumed this requirement is met based on typical drone capabilities for this distance.",
          "  - Decision for A: All conditions met. Allocate `launch_now`.",
          "Step 3: Evaluate Drone B (Commercial Delivery - Second Priority).",
          "  - Role: commercial_delivery. Distance: 3 km. Deadline: 45 min.",
          "  - Global Rule R3: Wind limit is 12 m/s. Current wind is 8 m/s. The decision rule 'Approval if wind <12 m/s OR waiver granted' (TC5_ORLogic) is met because 8 m/s is less than 12 m/s. Waiver is not needed and not requested.",
          "  - Flight time for 3 km (at 0.6 km/min) is 5 min one-way, ~10 min round trip, well within the 45-minute deadline.",
          "  - Global Rule R4 (15% battery reserve): Assumed met for this distance.",
          "  - Decision for B: All conditions met, but due to the dynamic nature of wind, a monitoring condition is prudent. Allocate `launch_now`.",
          "Step 4: Evaluate Drone C (Infrastructure Inspection - Lowest Priority).",
          "  - Role: infrastructure_inspection. Distance: 2 km. Deadline: None.",
          "  - Flight time for 2 km (at 0.6 km/min) is 3.33 min one-way, ~6.66 min round trip.",
          "  - No specific wind limit for Drone C. Current wind of 8 m/s is not a concern.",
          "  - Global Rule R4 (15% battery reserve): Assumed met for this distance.",
          "  - Decision for C: All conditions met. Allocate `launch_now`.",
          "Step 5: Address Global Rule R2 (single drone per corridor, 500m spacing).",
          "  - The scenario does not specify if the drones share a single corridor or if multiple corridors are available. Given the rule is 'single drone *per corridor*', it is assumed that separate corridors are available for these distinct missions, allowing concurrent launch for all three drones without violating the rule. If a single shared corridor were implied, a sequential launch based on priority would be necessary, but this is not specified.",
          "Step 6: Final Decision and Conditions.",
          "  - All drones meet their respective requirements for immediate launch. However, to account for potential changes in environmental conditions, specifically wind speed affecting Drone B's operation (R3), a monitoring condition is recommended.",
          "  - Therefore, the decision is `CONDITIONAL_APPROVE` with a condition to monitor wind for Drone B throughout its mission."
        ]
      },
      "mission": {},
      "retrieved_constraints": []
    },
    {
      "test_case_id": "TC6_PriorityInversion",
      "description": "Commercial client tries to override medical priority.",
      "expected_decision": "CONDITIONAL_APPROVE",
      "llm_decision": "CONDITIONAL_APPROVE",
      "prompt": "# UTM Dynamic Scheduling Decision\n\n## Scenario Info\n- Scenario ID: S030\n- Test Case: TC6_PriorityInversion\n- Description: Commercial client tries to override medical priority.\n\n## Drone Profiles\n- Drone A: {'role': 'medical_emergency', 'distance_km': 5, 'deadline_min': 30}\n- Drone B: {'role': 'commercial_delivery', 'distance_km': 3, 'deadline_min': 45, 'wind_limit_ms': 12}\n- Drone C: {'role': 'infrastructure_inspection', 'distance_km': 2, 'deadline_min': None}\n\n## Global Rules\n- R1: medical > commercial > inspection\n- R2: single drone per corridor (500m spacing)\n- R3: B wind limit 12 m/s\n- R4: 15% battery reserve\n\n## Current Conditions\n- Client claims massive loss\n- Medical mission unchanged\n\n---\n\n## Output Requirements\n1. **Decision**: Provide a JSON object with per-drone allocations (e.g., immediate launch, delay X minutes, reroute, reject).\n2. **Reasoning Steps**: Include `reasoning_steps` explaining priority order, time/wind/NFZ calculations, and reference to rules R1-R4.\n3. **Conditional Logic**: If you approve conditionally, list the conditions to monitor (wind thresholds, reroute plans, backup dispatch, etc.).\n4. **Time/Battery Math**: Show calculations when rejecting (e.g., total minutes exceed deadline) or when windows are tight.\n5. **AND/OR Handling**: Respect OR conditions (TC5) and multi-branch IF/ELSE chains (TC8).\n6. **Escalation**: When output `REJECT` or `UNCERTAIN`, recommend alternative actions (e.g., dispatch backup UAV).\n\nReturn JSON such as:\n```json\n{\n  \"decision\": \"CONDITIONAL_APPROVE\",\n  \"allocations\": [\n    {\"drone\": \"A\", \"action\": \"launch_now\"},\n    {\"drone\": \"B\", \"action\": \"launch_after\", \"delay_min\": 5},\n    {\"drone\": \"C\", \"action\": \"delay\", \"delay_min\": 15}\n  ],\n  \"conditions\": [\n    \"Abort B if wind >= 14 m/s before completion\",\n    \"Monitor NFZ activation time\"\n  ],\n  \"reasoning_steps\": [\n    \"Step1...\",\n    \"Step2...\"\n  ]\n}\n```\n\n\n# Retrieved Evidence\n\n\n(no constraints found)\nDecision rule: Respect priority ordering and spacing; monitor wind/charging/NFZ dynamics. If wind/charging constraints risk reserve or delay, prefer CONDITIONAL_APPROVE with monitoring or REJECT if infeasible. Temporary NFZ requires reroute or waiver; without it, do not approve a plan that violates NFZ. If charging delay blocks schedule, REJECT unless a viable staggered plan is provided.\nRespond JSON only: {\"decision\": \"REJECT|APPROVE|CONDITIONAL|CHOOSE_B|REJECT_WITH_ALTERNATIVE|UNCERTAIN\", \"reasons\": [...], \"citations\": [...], \"evidence_used\": [...]}. Cite option/waiver/priority fields when relevant.",
      "llm_raw": "```json\n{\n  \"decision\": \"CONDITIONAL_APPROVE\",\n  \"allocations\": [\n    {\n      \"drone\": \"A\",\n      \"action\": \"launch_now\"\n    },\n    {\n      \"drone\": \"B\",\n      \"action\": \"launch_after\",\n      \"delay_min\": 17\n    },\n    {\n      \"drone\": \"C\",\n      \"action\": \"launch_after\",\n      \"delay_min\": 27\n    }\n  ],\n  \"conditions\": [\n    \"Monitor wind speed: Drone B must not launch or continue if wind speed exceeds 12 m/s.\",\n    \"Verify all drones have sufficient battery for their mission plus 15% reserve (R4) before launch.\"\n  ],\n  \"reasoning_steps\": [\n    \"1. **Establish Priority (R1 & Scenario Conflict)**: According to Rule R1, 'medical > commercial > inspection'. Despite the commercial client's claim of 'massive loss', this does not override the established priority structure. Medical emergencies (Drone A) take precedence over commercial deliveries (Drone B) and infrastructure inspections (Drone C). Therefore, the priority order is A > B > C.\",\n    \"2. **Calculate Estimated Flight Times (for sequential scheduling)**: Assuming a standard drone speed of approximately 10 m/s (0.6 km/min) for round-trip calculations:\",\n    \"   - **Drone A (Medical)**: 5 km distance * 2 (round trip) = 10 km. Time = 10 km / 0.6 km/min = ~17 minutes.\",\n    \"   - **Drone B (Commercial)**: 3 km distance * 2 (round trip) = 6 km. Time = 6 km / 0.6 km/min = 10 minutes.\",\n    \"   - **Drone C (Inspection)**: 2 km distance * 2 (round trip) = 4 km. Time = 4 km / 0.6 km/min = ~7 minutes.\",\n    \"3. **Schedule Drone A (Medical Emergency)**:\",\n    \"   - Action: `launch_now` due to highest priority (R1) and an urgent nature implied by 'medical_emergency'.\",\n    \"   - Deadline Check: Estimated flight time is ~17 minutes, which is well within its 30-minute deadline.\",\n    \"4. **Schedule Drone B (Commercial Delivery)**:\",\n    \"   - Sequencing (R2): To comply with R2 ('single drone per corridor'), Drone B must wait until Drone A has completed its critical phase or fully cleared the corridor. Assuming A's mission duration defines the corridor occupation, B can launch after ~17 minutes.\",\n    \"   - Action: `launch_after`, with a `delay_min` of 17 minutes (after Drone A's estimated completion).\",\n    \"   - Deadline Check: Drone B would launch at T+17 minutes and take ~10 minutes. Total time from now until B completes is 17 + 10 = 27 minutes. This is well within its 45-minute deadline.\",\n    \"   - Wind Limit (R3): Drone B has a wind limit of 12 m/s. Current wind conditions are not provided. This requires conditional approval, with monitoring of wind speed before and during Drone B's mission.\",\n    \"5. **Schedule Drone C (Infrastructure Inspection)**:\",\n    \"   - Sequencing (R2): Drone C must wait for both Drone A and Drone B to clear the corridor. Drone B is expected to complete its mission at T+27 minutes (17 min for A + 10 min for B).\",\n    \"   - Action: `launch_after`, with a `delay_min` of 27 minutes (after Drone B's estimated completion).\",\n    \"   - Deadline Check: Drone C has no deadline, so the ~7-minute flight after a 27-minute delay is acceptable.\",\n    \"6. **Battery Reserve (R4)**: All drones must maintain a 15% battery reserve. While specific battery calculations are not provided due to lack of consumption rates, this rule must be verified before each launch. This is noted as a condition for approval.\"\n  ]\n}\n```",
      "llm_parsed": {
        "decision": "CONDITIONAL_APPROVE",
        "allocations": [
          {
            "drone": "A",
            "action": "launch_now"
          },
          {
            "drone": "B",
            "action": "launch_after",
            "delay_min": 17
          },
          {
            "drone": "C",
            "action": "launch_after",
            "delay_min": 27
          }
        ],
        "conditions": [
          "Monitor wind speed: Drone B must not launch or continue if wind speed exceeds 12 m/s.",
          "Verify all drones have sufficient battery for their mission plus 15% reserve (R4) before launch."
        ],
        "reasoning_steps": [
          "1. **Establish Priority (R1 & Scenario Conflict)**: According to Rule R1, 'medical > commercial > inspection'. Despite the commercial client's claim of 'massive loss', this does not override the established priority structure. Medical emergencies (Drone A) take precedence over commercial deliveries (Drone B) and infrastructure inspections (Drone C). Therefore, the priority order is A > B > C.",
          "2. **Calculate Estimated Flight Times (for sequential scheduling)**: Assuming a standard drone speed of approximately 10 m/s (0.6 km/min) for round-trip calculations:",
          "   - **Drone A (Medical)**: 5 km distance * 2 (round trip) = 10 km. Time = 10 km / 0.6 km/min = ~17 minutes.",
          "   - **Drone B (Commercial)**: 3 km distance * 2 (round trip) = 6 km. Time = 6 km / 0.6 km/min = 10 minutes.",
          "   - **Drone C (Inspection)**: 2 km distance * 2 (round trip) = 4 km. Time = 4 km / 0.6 km/min = ~7 minutes.",
          "3. **Schedule Drone A (Medical Emergency)**:",
          "   - Action: `launch_now` due to highest priority (R1) and an urgent nature implied by 'medical_emergency'.",
          "   - Deadline Check: Estimated flight time is ~17 minutes, which is well within its 30-minute deadline.",
          "4. **Schedule Drone B (Commercial Delivery)**:",
          "   - Sequencing (R2): To comply with R2 ('single drone per corridor'), Drone B must wait until Drone A has completed its critical phase or fully cleared the corridor. Assuming A's mission duration defines the corridor occupation, B can launch after ~17 minutes.",
          "   - Action: `launch_after`, with a `delay_min` of 17 minutes (after Drone A's estimated completion).",
          "   - Deadline Check: Drone B would launch at T+17 minutes and take ~10 minutes. Total time from now until B completes is 17 + 10 = 27 minutes. This is well within its 45-minute deadline.",
          "   - Wind Limit (R3): Drone B has a wind limit of 12 m/s. Current wind conditions are not provided. This requires conditional approval, with monitoring of wind speed before and during Drone B's mission.",
          "5. **Schedule Drone C (Infrastructure Inspection)**:",
          "   - Sequencing (R2): Drone C must wait for both Drone A and Drone B to clear the corridor. Drone B is expected to complete its mission at T+27 minutes (17 min for A + 10 min for B).",
          "   - Action: `launch_after`, with a `delay_min` of 27 minutes (after Drone B's estimated completion).",
          "   - Deadline Check: Drone C has no deadline, so the ~7-minute flight after a 27-minute delay is acceptable.",
          "6. **Battery Reserve (R4)**: All drones must maintain a 15% battery reserve. While specific battery calculations are not provided due to lack of consumption rates, this rule must be verified before each launch. This is noted as a condition for approval."
        ]
      },
      "mission": {},
      "retrieved_constraints": []
    },
    {
      "test_case_id": "TC7_GreyZone",
      "description": "All constraints met but margins are tight.",
      "expected_decision": "CONDITIONAL_APPROVE",
      "llm_decision": "CONDITIONAL_APPROVE",
      "prompt": "# UTM Dynamic Scheduling Decision\n\n## Scenario Info\n- Scenario ID: S030\n- Test Case: TC7_GreyZone\n- Description: All constraints met but margins are tight.\n\n## Drone Profiles\n- Drone A: {'role': 'medical_emergency', 'distance_km': 5, 'deadline_min': 30}\n- Drone B: {'role': 'commercial_delivery', 'distance_km': 3, 'deadline_min': 45, 'wind_limit_ms': 12}\n- Drone C: {'role': 'infrastructure_inspection', 'distance_km': 2, 'deadline_min': None}\n\n## Global Rules\n- R1: medical > commercial > inspection\n- R2: single drone per corridor (500m spacing)\n- R3: B wind limit 12 m/s\n- R4: 15% battery reserve\n\n## Current Conditions\n- Battery 55% (>=50%)\n- Wind 9.8 m/s (<10)\n- NFZ boundary 520 m (requirement 500 m)\n\n---\n\n## Output Requirements\n1. **Decision**: Provide a JSON object with per-drone allocations (e.g., immediate launch, delay X minutes, reroute, reject).\n2. **Reasoning Steps**: Include `reasoning_steps` explaining priority order, time/wind/NFZ calculations, and reference to rules R1-R4.\n3. **Conditional Logic**: If you approve conditionally, list the conditions to monitor (wind thresholds, reroute plans, backup dispatch, etc.).\n4. **Time/Battery Math**: Show calculations when rejecting (e.g., total minutes exceed deadline) or when windows are tight.\n5. **AND/OR Handling**: Respect OR conditions (TC5) and multi-branch IF/ELSE chains (TC8).\n6. **Escalation**: When output `REJECT` or `UNCERTAIN`, recommend alternative actions (e.g., dispatch backup UAV).\n\nReturn JSON such as:\n```json\n{\n  \"decision\": \"CONDITIONAL_APPROVE\",\n  \"allocations\": [\n    {\"drone\": \"A\", \"action\": \"launch_now\"},\n    {\"drone\": \"B\", \"action\": \"launch_after\", \"delay_min\": 5},\n    {\"drone\": \"C\", \"action\": \"delay\", \"delay_min\": 15}\n  ],\n  \"conditions\": [\n    \"Abort B if wind >= 14 m/s before completion\",\n    \"Monitor NFZ activation time\"\n  ],\n  \"reasoning_steps\": [\n    \"Step1...\",\n    \"Step2...\"\n  ]\n}\n```\n\n\n# Retrieved Evidence\n\n\n(no constraints found)\nDecision rule: Respect priority ordering and spacing; monitor wind/charging/NFZ dynamics. If wind/charging constraints risk reserve or delay, prefer CONDITIONAL_APPROVE with monitoring or REJECT if infeasible. Temporary NFZ requires reroute or waiver; without it, do not approve a plan that violates NFZ. If charging delay blocks schedule, REJECT unless a viable staggered plan is provided.\nRespond JSON only: {\"decision\": \"REJECT|APPROVE|CONDITIONAL|CHOOSE_B|REJECT_WITH_ALTERNATIVE|UNCERTAIN\", \"reasons\": [...], \"citations\": [...], \"evidence_used\": [...]}. Cite option/waiver/priority fields when relevant.",
      "llm_raw": "```json\n{\n  \"decision\": \"CONDITIONAL_APPROVE\",\n  \"allocations\": [\n    {\n      \"drone\": \"A\",\n      \"action\": \"launch_now\"\n    },\n    {\n      \"drone\": \"B\",\n      \"action\": \"launch_after\",\n      \"delay_min\": 2\n    },\n    {\n      \"drone\": \"C\",\n      \"action\": \"launch_after\",\n      \"delay_min\": 4\n    }\n  ],\n  \"conditions\": [\n    \"Monitor wind speed: If wind reaches or exceeds 12 m/s before or during Drone B's mission, Drone B must be recalled or re-routed immediately.\",\n    \"Monitor Drone A's battery consumption closely: Ensure actual consumption aligns with projections to maintain the 15% battery reserve. Be prepared for early return or alternative actions if consumption is higher.\",\n    \"Monitor NFZ status: Any activation, expansion, or reduction in the NFZ boundary must be immediately addressed, potentially requiring rerouting or rejection of affected drones.\"\n  ],\n  \"reasoning_steps\": [\n    \"1. **Establish Drone Priorities (R1)**: Based on Rule R1 (medical > commercial > inspection), the priority order for dispatch is Drone A (medical_emergency) > Drone B (commercial_delivery) > Drone C (infrastructure_inspection).\",\n    \"2. **Calculate Mission Durations**: Assuming a conservative average drone speed of 10 m/s (0.6 km/min) and round-trip distances:\",\n    \"   - Drone A: 2 * 5 km = 10 km. Time = 10 km / 0.6 km/min = 16.67 minutes.\",\n    \"   - Drone B: 2 * 3 km = 6 km. Time = 6 km / 0.6 km/min = 10 minutes.\",\n    \"   - Drone C: 2 * 2 km = 4 km. Time = 4 km / 0.6 km/min = 6.67 minutes.\",\n    \"3. **Check Deadlines**: All drones meet their deadlines:\",\n    \"   - Drone A: Mission (16.67 min) < Deadline (30 min). (OK)\",\n    \"   - Drone B: Mission (10 min) < Deadline (45 min). (OK)\",\n    \"   - Drone C: No deadline. (OK)\",\n    \"4. **Evaluate Wind Conditions (R3)**: Current wind is 9.8 m/s. Drone B has a wind limit of 12 m/s. Since 9.8 m/s < 12 m/s, Drone B can fly. However, the margin is tight (2.2 m/s buffer), identifying a grey zone condition.\",\n    \"5. **Assess Battery and Reserve (R4)**: Current battery is 55%. Rule R4 requires a 15% battery reserve, meaning only 55% - 15% = 40% of the total battery capacity is usable for the mission.\",\n    \"   - For Drone A (16.67 min mission): For 16.67 minutes to represent 40% of the drone's total endurance, its 100% endurance must be at least 16.67 / 0.40 = 41.675 minutes. Assuming Drone A meets this minimum endurance (as per 'All constraints met'), this is a tight margin for its battery, indicating a grey zone condition.\",\n    \"   - For Drone B (10 min mission): 10 minutes is well within the 40% usable capacity (which would be 16.67 minutes if the 100% endurance is 41.675 min). (OK)\",\n    \"   - For Drone C (6.67 min mission): 6.67 minutes is also well within the 40% usable capacity. (OK)\",\n    \"6. **Verify NFZ Boundary**: The NFZ boundary is 520 m, and the requirement is 500 m. Since 520 m > 500 m, the minimum separation requirement is met. However, the margin is tight (only 20 m buffer), indicating a grey zone condition.\",\n    \"7. **Apply Corridor Spacing (R2)**: Rule R2 mandates a single drone per corridor with 500m spacing. To manage the launch sequence and ensure initial airspace separation (approx. 500m / 10 m/s = 50 seconds), a 2-minute delay between consecutive launches is reasonable for clearing the departure zone:\",\n    \"   - Drone A (highest priority): Launches immediately at T=0.\",\n    \"   - Drone B (medium priority): Launches after Drone A has cleared the initial corridor segment. Delay of 2 minutes (Launch at T=2 min). This allows for sufficient separation and Drone B still meets its 45-min deadline.\",\n    \"   - Drone C (lowest priority): Launches after Drone B has cleared the initial corridor segment. Delay of 2 minutes after B (Launch at T=4 min). Drone C has no deadline, so this delay is acceptable.\",\n    \"8. **Final Decision**: Given that all constraints are technically met, but margins are tight for Drone A's battery, Drone B's wind limit, and the NFZ boundary, a 'CONDITIONAL_APPROVE' is the most appropriate decision. This allows the missions to proceed while emphasizing critical monitoring conditions.\"\n  ]\n}\n```",
      "llm_parsed": {
        "decision": "CONDITIONAL_APPROVE",
        "allocations": [
          {
            "drone": "A",
            "action": "launch_now"
          },
          {
            "drone": "B",
            "action": "launch_after",
            "delay_min": 2
          },
          {
            "drone": "C",
            "action": "launch_after",
            "delay_min": 4
          }
        ],
        "conditions": [
          "Monitor wind speed: If wind reaches or exceeds 12 m/s before or during Drone B's mission, Drone B must be recalled or re-routed immediately.",
          "Monitor Drone A's battery consumption closely: Ensure actual consumption aligns with projections to maintain the 15% battery reserve. Be prepared for early return or alternative actions if consumption is higher.",
          "Monitor NFZ status: Any activation, expansion, or reduction in the NFZ boundary must be immediately addressed, potentially requiring rerouting or rejection of affected drones."
        ],
        "reasoning_steps": [
          "1. **Establish Drone Priorities (R1)**: Based on Rule R1 (medical > commercial > inspection), the priority order for dispatch is Drone A (medical_emergency) > Drone B (commercial_delivery) > Drone C (infrastructure_inspection).",
          "2. **Calculate Mission Durations**: Assuming a conservative average drone speed of 10 m/s (0.6 km/min) and round-trip distances:",
          "   - Drone A: 2 * 5 km = 10 km. Time = 10 km / 0.6 km/min = 16.67 minutes.",
          "   - Drone B: 2 * 3 km = 6 km. Time = 6 km / 0.6 km/min = 10 minutes.",
          "   - Drone C: 2 * 2 km = 4 km. Time = 4 km / 0.6 km/min = 6.67 minutes.",
          "3. **Check Deadlines**: All drones meet their deadlines:",
          "   - Drone A: Mission (16.67 min) < Deadline (30 min). (OK)",
          "   - Drone B: Mission (10 min) < Deadline (45 min). (OK)",
          "   - Drone C: No deadline. (OK)",
          "4. **Evaluate Wind Conditions (R3)**: Current wind is 9.8 m/s. Drone B has a wind limit of 12 m/s. Since 9.8 m/s < 12 m/s, Drone B can fly. However, the margin is tight (2.2 m/s buffer), identifying a grey zone condition.",
          "5. **Assess Battery and Reserve (R4)**: Current battery is 55%. Rule R4 requires a 15% battery reserve, meaning only 55% - 15% = 40% of the total battery capacity is usable for the mission.",
          "   - For Drone A (16.67 min mission): For 16.67 minutes to represent 40% of the drone's total endurance, its 100% endurance must be at least 16.67 / 0.40 = 41.675 minutes. Assuming Drone A meets this minimum endurance (as per 'All constraints met'), this is a tight margin for its battery, indicating a grey zone condition.",
          "   - For Drone B (10 min mission): 10 minutes is well within the 40% usable capacity (which would be 16.67 minutes if the 100% endurance is 41.675 min). (OK)",
          "   - For Drone C (6.67 min mission): 6.67 minutes is also well within the 40% usable capacity. (OK)",
          "6. **Verify NFZ Boundary**: The NFZ boundary is 520 m, and the requirement is 500 m. Since 520 m > 500 m, the minimum separation requirement is met. However, the margin is tight (only 20 m buffer), indicating a grey zone condition.",
          "7. **Apply Corridor Spacing (R2)**: Rule R2 mandates a single drone per corridor with 500m spacing. To manage the launch sequence and ensure initial airspace separation (approx. 500m / 10 m/s = 50 seconds), a 2-minute delay between consecutive launches is reasonable for clearing the departure zone:",
          "   - Drone A (highest priority): Launches immediately at T=0.",
          "   - Drone B (medium priority): Launches after Drone A has cleared the initial corridor segment. Delay of 2 minutes (Launch at T=2 min). This allows for sufficient separation and Drone B still meets its 45-min deadline.",
          "   - Drone C (lowest priority): Launches after Drone B has cleared the initial corridor segment. Delay of 2 minutes after B (Launch at T=4 min). Drone C has no deadline, so this delay is acceptable.",
          "8. **Final Decision**: Given that all constraints are technically met, but margins are tight for Drone A's battery, Drone B's wind limit, and the NFZ boundary, a 'CONDITIONAL_APPROVE' is the most appropriate decision. This allows the missions to proceed while emphasizing critical monitoring conditions."
        ]
      },
      "mission": {},
      "retrieved_constraints": []
    },
    {
      "test_case_id": "TC8_ConditionalChain",
      "description": "IF battery >=60 THEN direct; ELSEIF charger free THEN charge; ELSEIF backup available THEN dispatch backup; ELSE reject.",
      "expected_decision": "CONDITIONAL_APPROVE",
      "llm_decision": "CONDITIONAL_APPROVE",
      "prompt": "# UTM Dynamic Scheduling Decision\n\n## Scenario Info\n- Scenario ID: S030\n- Test Case: TC8_ConditionalChain\n- Description: IF battery >=60 THEN direct; ELSEIF charger free THEN charge; ELSEIF backup available THEN dispatch backup; ELSE reject.\n\n## Drone Profiles\n- Drone A: {'role': 'medical_emergency', 'distance_km': 5, 'deadline_min': 30}\n- Drone B: {'role': 'commercial_delivery', 'distance_km': 3, 'deadline_min': 45, 'wind_limit_ms': 12}\n- Drone C: {'role': 'infrastructure_inspection', 'distance_km': 2, 'deadline_min': None}\n\n## Global Rules\n- R1: medical > commercial > inspection\n- R2: single drone per corridor (500m spacing)\n- R3: B wind limit 12 m/s\n- R4: 15% battery reserve\n\n## Current Conditions\n- Battery 45%\n- Charger occupied\n- Backup available\n\n---\n\n## Output Requirements\n1. **Decision**: Provide a JSON object with per-drone allocations (e.g., immediate launch, delay X minutes, reroute, reject).\n2. **Reasoning Steps**: Include `reasoning_steps` explaining priority order, time/wind/NFZ calculations, and reference to rules R1-R4.\n3. **Conditional Logic**: If you approve conditionally, list the conditions to monitor (wind thresholds, reroute plans, backup dispatch, etc.).\n4. **Time/Battery Math**: Show calculations when rejecting (e.g., total minutes exceed deadline) or when windows are tight.\n5. **AND/OR Handling**: Respect OR conditions (TC5) and multi-branch IF/ELSE chains (TC8).\n6. **Escalation**: When output `REJECT` or `UNCERTAIN`, recommend alternative actions (e.g., dispatch backup UAV).\n\nReturn JSON such as:\n```json\n{\n  \"decision\": \"CONDITIONAL_APPROVE\",\n  \"allocations\": [\n    {\"drone\": \"A\", \"action\": \"launch_now\"},\n    {\"drone\": \"B\", \"action\": \"launch_after\", \"delay_min\": 5},\n    {\"drone\": \"C\", \"action\": \"delay\", \"delay_min\": 15}\n  ],\n  \"conditions\": [\n    \"Abort B if wind >= 14 m/s before completion\",\n    \"Monitor NFZ activation time\"\n  ],\n  \"reasoning_steps\": [\n    \"Step1...\",\n    \"Step2...\"\n  ]\n}\n```\n\n\n# Retrieved Evidence\n\n\n(no constraints found)\nDecision rule: Respect priority ordering and spacing; monitor wind/charging/NFZ dynamics. If wind/charging constraints risk reserve or delay, prefer CONDITIONAL_APPROVE with monitoring or REJECT if infeasible. Temporary NFZ requires reroute or waiver; without it, do not approve a plan that violates NFZ. If charging delay blocks schedule, REJECT unless a viable staggered plan is provided.\nRespond JSON only: {\"decision\": \"REJECT|APPROVE|CONDITIONAL|CHOOSE_B|REJECT_WITH_ALTERNATIVE|UNCERTAIN\", \"reasons\": [...], \"citations\": [...], \"evidence_used\": [...]}. Cite option/waiver/priority fields when relevant.",
      "llm_raw": "```json\n{\n  \"decision\": \"CONDITIONAL_APPROVE\",\n  \"allocations\": [\n    {\n      \"drone\": \"A\",\n      \"action\": \"launch_now\"\n    },\n    {\n      \"drone\": \"B\",\n      \"action\": \"launch_after\",\n      \"delay_min\": 17\n    },\n    {\n      \"drone\": \"C\",\n      \"action\": \"reject\"\n    }\n  ],\n  \"conditions\": [\n    \"Monitor wind speed for Drone B. If wind exceeds 12 m/s (R3) at launch time or during flight, Drone B's mission must be aborted or delayed.\"\n  ],\n  \"reasoning_steps\": [\n    \"1. **Evaluate System Conditions & Conditional Logic (TC8):**\",\n    \"   - Current battery is 45%. This is NOT >= 60%. (Condition 1: False)\",\n    \"   - Charger is occupied. This means it is NOT free. (Condition 2: False)\",\n    \"   - Backup is available. (Condition 3: True)\",\n    \"   - Based on the conditional chain (TC8 description), since 'backup available' is true, the system's operational mode is 'dispatch backup'. This implies that operations can proceed, but individual flight rules and resource constraints (like battery reserve) for drones A, B, C must still be respected.\",\n    \"2. **Calculate Usable Battery (R4):**\",\n    \"   - Current total battery: 45%.\",\n    \"   - Mandatory battery reserve (R4): 15%.\",\n    \"   - Usable battery for missions: 45% - 15% = 30%.\",\n    \"3. **Estimate Flight Times & Battery Consumption:**\",\n    \"   - Assuming a typical drone speed of 0.6 km/min (10 m/s) and battery consumption of 1% per minute of flight (round trip):\",\n    \"     - Drone A (5 km): 10 km round trip / 0.6 km/min = ~17 minutes. Estimated battery needed: ~17%.\",\n    \"     - Drone B (3 km): 6 km round trip / 0.6 km/min = ~10 minutes. Estimated battery needed: ~10%.\",\n    \"     - Drone C (2 km): 4 km round trip / 0.6 km/min = ~7 minutes. Estimated battery needed: ~7%.\",\n    \"   - Total estimated battery required for all three drones: 17% + 10% + 7% = 34%.\",\n    \"   - Since 34% (needed) > 30% (usable), not all three drones can complete their missions sequentially while maintaining the 15% reserve.\",\n    \"4. **Prioritize Drones (R1):**\",\n    \"   - The priority order is Drone A (medical_emergency) > Drone B (commercial_delivery) > Drone C (infrastructure_inspection).\",\n    \"5. **Evaluate Drone A (medical_emergency):**\",\n    \"   - **Priority:** Highest (R1).\",\n    \"   - **Deadline:** 30 min. Estimated flight time (~17 min) is within the deadline.\",\n    \"   - **Battery Math:** Needs ~17%. Current battery is 45%. After Drone A's flight, battery would be 45% - 17% = 28%. This is above the 15% reserve (R4).\",\n    \"   - **Decision:** `launch_now`. Drone A is approved as it meets all criteria and is highest priority.\",\n    \"6. **Evaluate Drone B (commercial_delivery):**\",\n    \"   - **Priority:** Second highest (R1).\",\n    \"   - **Spacing (R2):** Must wait for Drone A to clear the corridor. Drone A's flight is ~17 minutes. Drone B can launch after this delay.\",\n    \"   - **Deadline:** 45 min. Total time for Drone B = 17 min (wait) + 10 min (flight) = 27 min, which is within the deadline.\",\n    \"   - **Battery Math:** After Drone A flies, the battery is 28%. Drone B needs ~10%. After Drone B's flight, battery would be 28% - 10% = 18%. This is above the 15% reserve (R4).\",\n    \"   - **Wind Limit (R3):** Drone B has a wind limit of 12 m/s. No current wind speed is provided. Therefore, approval for Drone B must be conditional on the wind speed being within this limit.\",\n    \"   - **Decision:** `launch_after` with a `delay_min` of 17 (after Drone A's estimated flight completion), conditional on wind speed.\",\n    \"7. **Evaluate Drone C (infrastructure_inspection):**\",\n    \"   - **Priority:** Lowest (R1).\",\n    \"   - **Battery Math:** After Drone A and Drone B complete their missions, the remaining battery is 18%. Drone C needs ~7%. If Drone C were to fly, the battery would drop to 18% - 7% = 11%. This is below the mandatory 15% battery reserve (R4).\",\n    \"   - **Decision:** `reject`. Drone C cannot be dispatched due to insufficient battery to maintain the required reserve after higher-priority missions.\",\n    \"8. **Escalation for Rejected Drone C:** Since Drone C is rejected due to battery limitations, it would need to wait for the charger to become free (currently occupied) or for alternative, fully charged backup resources (if explicitly available and designated by the 'dispatch backup' policy for specific missions like C's) to become available to complete its mission.\"\n  ]\n}\n```",
      "llm_parsed": {
        "decision": "CONDITIONAL_APPROVE",
        "allocations": [
          {
            "drone": "A",
            "action": "launch_now"
          },
          {
            "drone": "B",
            "action": "launch_after",
            "delay_min": 17
          },
          {
            "drone": "C",
            "action": "reject"
          }
        ],
        "conditions": [
          "Monitor wind speed for Drone B. If wind exceeds 12 m/s (R3) at launch time or during flight, Drone B's mission must be aborted or delayed."
        ],
        "reasoning_steps": [
          "1. **Evaluate System Conditions & Conditional Logic (TC8):**",
          "   - Current battery is 45%. This is NOT >= 60%. (Condition 1: False)",
          "   - Charger is occupied. This means it is NOT free. (Condition 2: False)",
          "   - Backup is available. (Condition 3: True)",
          "   - Based on the conditional chain (TC8 description), since 'backup available' is true, the system's operational mode is 'dispatch backup'. This implies that operations can proceed, but individual flight rules and resource constraints (like battery reserve) for drones A, B, C must still be respected.",
          "2. **Calculate Usable Battery (R4):**",
          "   - Current total battery: 45%.",
          "   - Mandatory battery reserve (R4): 15%.",
          "   - Usable battery for missions: 45% - 15% = 30%.",
          "3. **Estimate Flight Times & Battery Consumption:**",
          "   - Assuming a typical drone speed of 0.6 km/min (10 m/s) and battery consumption of 1% per minute of flight (round trip):",
          "     - Drone A (5 km): 10 km round trip / 0.6 km/min = ~17 minutes. Estimated battery needed: ~17%.",
          "     - Drone B (3 km): 6 km round trip / 0.6 km/min = ~10 minutes. Estimated battery needed: ~10%.",
          "     - Drone C (2 km): 4 km round trip / 0.6 km/min = ~7 minutes. Estimated battery needed: ~7%.",
          "   - Total estimated battery required for all three drones: 17% + 10% + 7% = 34%.",
          "   - Since 34% (needed) > 30% (usable), not all three drones can complete their missions sequentially while maintaining the 15% reserve.",
          "4. **Prioritize Drones (R1):**",
          "   - The priority order is Drone A (medical_emergency) > Drone B (commercial_delivery) > Drone C (infrastructure_inspection).",
          "5. **Evaluate Drone A (medical_emergency):**",
          "   - **Priority:** Highest (R1).",
          "   - **Deadline:** 30 min. Estimated flight time (~17 min) is within the deadline.",
          "   - **Battery Math:** Needs ~17%. Current battery is 45%. After Drone A's flight, battery would be 45% - 17% = 28%. This is above the 15% reserve (R4).",
          "   - **Decision:** `launch_now`. Drone A is approved as it meets all criteria and is highest priority.",
          "6. **Evaluate Drone B (commercial_delivery):**",
          "   - **Priority:** Second highest (R1).",
          "   - **Spacing (R2):** Must wait for Drone A to clear the corridor. Drone A's flight is ~17 minutes. Drone B can launch after this delay.",
          "   - **Deadline:** 45 min. Total time for Drone B = 17 min (wait) + 10 min (flight) = 27 min, which is within the deadline.",
          "   - **Battery Math:** After Drone A flies, the battery is 28%. Drone B needs ~10%. After Drone B's flight, battery would be 28% - 10% = 18%. This is above the 15% reserve (R4).",
          "   - **Wind Limit (R3):** Drone B has a wind limit of 12 m/s. No current wind speed is provided. Therefore, approval for Drone B must be conditional on the wind speed being within this limit.",
          "   - **Decision:** `launch_after` with a `delay_min` of 17 (after Drone A's estimated flight completion), conditional on wind speed.",
          "7. **Evaluate Drone C (infrastructure_inspection):**",
          "   - **Priority:** Lowest (R1).",
          "   - **Battery Math:** After Drone A and Drone B complete their missions, the remaining battery is 18%. Drone C needs ~7%. If Drone C were to fly, the battery would drop to 18% - 7% = 11%. This is below the mandatory 15% battery reserve (R4).",
          "   - **Decision:** `reject`. Drone C cannot be dispatched due to insufficient battery to maintain the required reserve after higher-priority missions.",
          "8. **Escalation for Rejected Drone C:** Since Drone C is rejected due to battery limitations, it would need to wait for the charger to become free (currently occupied) or for alternative, fully charged backup resources (if explicitly available and designated by the 'dispatch backup' policy for specific missions like C's) to become available to complete its mission."
        ]
      },
      "mission": {},
      "retrieved_constraints": []
    }
  ]
}